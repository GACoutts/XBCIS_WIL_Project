<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Management Demo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 8px; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .primary { background: #007bff; color: white; }
        .success { background: #28a745; color: white; }
        .danger { background: #dc3545; color: white; }
        .info { background: #17a2b8; color: white; }
        input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .result { background: #e9ecef; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; }
        .session-item { background: white; padding: 10px; margin: 5px 0; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <h1>🔐 Dual-Token Session Management Demo</h1>
    
    <div class="section">
        <h3>🚀 Authentication</h3>
        <div>
            <input type="email" id="email" placeholder="Email" value="manual-test@example.com">
            <input type="password" id="password" placeholder="Password" value="testpassword123">
            <button class="primary" onclick="login()">Login</button>
            <button class="success" onclick="getCurrentUser()">Get User</button>
            <button class="danger" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="section">
        <h3>📱 Session Management</h3>
        <button class="info" onclick="listSessions()">List Sessions</button>
        <button class="info" onclick="refreshTokens()">Refresh Tokens</button>
        <button class="danger" onclick="logoutAll()">Logout All Devices</button>
        <div id="sessions-list"></div>
    </div>

    <div class="section">
        <h3>🔑 Password Reset</h3>
        <div>
            <input type="email" id="resetEmail" placeholder="Email" value="manual-test@example.com">
            <button class="info" onclick="requestPasswordReset()">Request Reset</button>
        </div>
        <div>
            <input type="text" id="resetToken" placeholder="Reset Token (check console)">
            <input type="password" id="newPassword" placeholder="New Password">
            <button class="success" onclick="resetPassword()">Reset Password</button>
        </div>
    </div>

    <div class="section">
        <h3>📊 Results</h3>
        <div id="results" class="result">Ready to test...</div>
    </div>

    <script>
        const API_BASE = '/api/auth';
        const results = document.getElementById('results');
        
        function log(message) {
            results.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '\n';
            console.log(message);
        }

        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(API_BASE + endpoint, {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    ...options
                });
                
                const data = await response.json();
                const status = response.ok ? '✅' : '❌';
                log(`${status} ${endpoint}: ${JSON.stringify(data, null, 2)}`);
                return { response, data };
            } catch (error) {
                log(`❌ ${endpoint}: ${error.message}`);
                return { error };
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            await apiCall('/login', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });
        }

        async function getCurrentUser() {
            await apiCall('/me');
        }

        async function logout() {
            await apiCall('/logout', { method: 'POST' });
        }

        async function logoutAll() {
            await apiCall('/logout-all', { method: 'POST' });
        }

        async function listSessions() {
            const result = await apiCall('/sessions');
            if (result.data && result.data.sessions) {
                const sessionsList = document.getElementById('sessions-list');
                sessionsList.innerHTML = result.data.sessions.map(session => `
                    <div class="session-item">
                        <strong>Session ${session.tokenId}</strong><br>
                        IP: ${session.ip || 'Unknown'}<br>
                        Device: ${session.userAgent ? session.userAgent.substring(0, 50) + '...' : 'Unknown'}<br>
                        Issued: ${new Date(session.issuedAt).toLocaleString()}<br>
                        Expires: ${new Date(session.expiresAt).toLocaleString()}
                        <button class="danger" onclick="revokeSession(${session.tokenId})">Revoke</button>
                    </div>
                `).join('');
            }
        }

        async function revokeSession(tokenId) {
            await apiCall(`/sessions/${tokenId}`, { method: 'DELETE' });
            listSessions(); // Refresh list
        }

        async function refreshTokens() {
            await apiCall('/refresh', { method: 'POST' });
        }

        async function requestPasswordReset() {
            const email = document.getElementById('resetEmail').value;
            await apiCall('/request-password-reset', {
                method: 'POST',
                body: JSON.stringify({ email })
            });
            log('🔍 Check the server console for the reset token!');
        }

        async function resetPassword() {
            const token = document.getElementById('resetToken').value;
            const password = document.getElementById('newPassword').value;
            
            await apiCall('/reset-password', {
                method: 'POST',
                body: JSON.stringify({ token, password })
            });
        }

        // Auto-login on load for demo
        setTimeout(() => {
            log('🎪 Demo loaded! Try logging in first.');
        }, 500);
    </script>
</body>
</html>
